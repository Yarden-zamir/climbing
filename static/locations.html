<!DOCTYPE html>
<html lang="en">
<head>
  <link id="favicon" rel="icon" type="image/x-icon" href="/static/favicon/favicon.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse climbing locations with maps, approach info, and albums from each location." />
  <title>Locations</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#bb86fc">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Climbing">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link rel="preload" href="/static/js/auth.js" as="script">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    /* Emoji picker component theming (Shadow DOM via CSS vars) */
    emoji-picker {
      --background: #1b1b1b;
      --border-color: #333;
      --border-size: 1px;
      --border-radius: 12px; /* match app radius */
      --button-hover-background: #262626;
      --button-active-background: #2e2e2e;
      --category-font-color: #e0e0e0;
      --category-emoji-size: 20px;
      --category-emoji-padding: 6px;
      --emoji-size: 22px;
      --num-columns: 8;
      --input-background: #121212;
      --input-font-color: #f0f0f0;
      --font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --emoji-font-family: Apple Color Emoji, 'Noto Color Emoji', 'Segoe UI Emoji', system-ui, sans-serif;
    }
    /* Page scaffold */
    .locations-page { padding: 1rem; }
    .locations-header { display: flex; gap: 0.75rem; align-items: center; margin: 0.5rem 0 1rem; justify-content: space-between; }
    .locations-count { color: #aaa; font-size: 0.95rem; }

    /* Search FAB */
    .search-fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px; height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #bb86fc 0%, #7c4dff 100%);
      box-shadow: 0 6px 20px rgba(187, 134, 252, 0.4);
      display: inline-flex; align-items: center; justify-content: center;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      z-index: 1000;
    }
    .search-fab:hover { transform: scale(1.08); box-shadow: 0 8px 30px rgba(187, 134, 252, 0.6); }
    .search-fab:active { transform: scale(0.95); }
    .search-fab.active { background: linear-gradient(135deg, #03dac6 0%, #018786 100%); }
    .search-fab-icon { font-size: 1.5rem; color: #fff; }

    /* Search Popup */
    .search-popup-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      pointer-events: none; opacity: 0; transition: opacity 0.2s ease; z-index: 999;
    }
    .search-popup-overlay.active { pointer-events: auto; opacity: 1; }
    .search-popup {
      position: fixed; bottom: 6rem; right: 2rem; width: min(480px, 92vw);
      background: rgba(18,18,18,0.92);
      border-radius: 16px; border: 1px solid #333;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      transform: translateY(12px) scale(0.98); opacity: 0; visibility: hidden;
      transition: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1001;
    }
    .search-popup.active { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
    .search-popup-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.2rem; border-bottom: 1px solid #333; }
    .search-popup-title { font-size: 1.1rem; font-weight: 700; color: #fff; }
    .search-popup-close { background: none; border: none; color: #bbb; font-size: 1.2rem; cursor: pointer; border-radius: 8px; padding: 0.25rem 0.5rem; }
    .search-popup-close:hover { background: #333; color: #fff; }
    .search-popup-content { padding: 1rem 1.2rem; }
    .search-input { width: 100%; padding: 0.85rem 1rem; border-radius: 12px; border: 2px solid #333; background: #222; color: #fff; }
    .search-popup-footer { padding: 0.75rem 1.2rem 1.1rem; display: flex; gap: 0.6rem; justify-content: flex-end; }
    .search-action-btn { background: linear-gradient(135deg, #333 0%, #444 100%); border: 1px solid #555; color: #e0e0e0; padding: 0.6rem 0.9rem; border-radius: 10px; cursor: pointer; }
    .search-action-btn:hover { border-color: #bb86fc; }

    /* Location section */
    .location-section { border: 1px solid #2f2f2f; border-radius: 16px; padding: 1rem; margin: 0 0 1rem; background: linear-gradient(135deg, #161616 0%, #1f1f1f 100%); }
    .location-section.selected { border-color: #bb86fc; box-shadow: 0 0 0 2px rgba(187,134,252,0.18) inset; }
    .location-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .location-title { display: flex; gap: 0.5rem; align-items: center; color: #fff; font-weight: 700; flex: 1; min-width: 0; }
    .location-title input[type="text"] { max-width: 100%; width: min(100%, 26ch); box-sizing: border-box; }
    .location-title .pin { font-size: 1.2rem; }
    .location-actions { display: flex; gap: 0.5rem; flex: 0 0 auto; }
    .location-btn { background: #333; border: 1px solid #444; color: #ddd; padding: 0.4rem 0.7rem; border-radius: 10px; cursor: pointer; font-size: 0.75rem; }
    .location-btn:hover { border-color: #bb86fc; }
    /* Icon-only variant for nav apps */
    .icon-btn { width: 42px; height: 42px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .icon-btn svg { width: 22px; height: 22px; color: #ddd; }
    .icon-btn:hover svg { color: #bb86fc; }
    .icon-btn img { width: 22px; height: 22px; display: block; }

    /* Two-column responsive: map + details */
    .location-body { display: grid; grid-template-columns: 360px 1fr; gap: 0.5rem; align-items: start; }
    .location-map { position: relative; width: 100%; aspect-ratio: 4 / 3; border: 1px solid #333; border-radius: 12px; overflow: hidden; background: #111; }
    .location-map .map-viewport { width: 100%; height: 100%; pointer-events: auto; touch-action: auto; }
    /* Edge scroll gutters: small top/bottom strips that route scroll to the page */
    .map-scroll-gutter { position: absolute; left: 0; right: 0; height: 96px; z-index: 2500; opacity: 1; transition: opacity 1000ms cubic-bezier(0.4, 0, 0.2, 1); pointer-events: auto; will-change: opacity; }
    .map-scroll-gutter.top { top: 0; background: linear-gradient(180deg, rgba(3,218,198,0.35), rgba(3,218,198,0)); }
    .map-scroll-gutter.bottom { bottom: 0; background: linear-gradient(0deg, rgba(3,218,198,0.35), rgba(3,218,198,0)); }
    .map-scroll-gutter.hidden { opacity: 0; pointer-events: none; }
    /* Let gutters allow vertical page scrolling via CSS touch-action */
    @supports (touch-action: pan-y) {
      .map-scroll-gutter { touch-action: pan-y; }
    }
    .location-info { display: flex; flex-direction: column; gap: 0.5rem; min-width: 0; }
    .map-col { display: flex; flex-direction: column; }
    .coords-row { margin-top: 0.4rem; }
    .location-approach { background: #202020; border: 1px solid #333; border-radius: 12px; padding: 0.75rem; color: #ddd; line-height: 1.5; }
    .location-approach .heading { color: #aaa; font-weight: 600; font-size: 0.95rem; margin-bottom: 0.4rem; }

    /* Albums scroller */
    .albums-scroller {
      display: flex;
      gap: 0.6rem;
      width: 100%;
      overflow-x: auto;
      overflow-y: visible;
      /* Use negative margins with compensating padding so glow/hover can extend without changing layout */
      margin-top: -6px;
      padding-top: 6px;
      margin-bottom: -6px;
      padding-bottom: 6px;
      contain: layout; /* Remove paint containment to allow glow effects */
      /* Hide scrollbar (Firefox) */
      scrollbar-width: none;
      /* Hide scrollbar (IE/Edge legacy) */
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch;
      touch-action: auto;
    }
    /* Hide scrollbar (WebKit) */
    .albums-scroller::-webkit-scrollbar { display: none; }
    .mini-album-card {
      flex: 0 0 auto; width: 180px;
      border-radius: 12px; border: 1px solid #333; background: #222;
      text-decoration: none; color: inherit;
      box-shadow: 0 3px 6px rgba(0,0,0,0.22);
      transition: transform 90ms ease;
      will-change: transform; transform: translateZ(0);
      position: relative; /* Needed for NEW badge positioning */
    }
    /* Ensure hover/glow effects are never clipped by the card box */
    .mini-album-card { overflow: visible; }
    .mini-album-card:hover { transform: translateY(-2px); z-index: 2; }
    .mini-album-card:focus-visible { outline: none; transform: translateY(-2px); }
    .mini-album-img { width: 100%; height: 220px; object-fit: cover; border-radius: 12px 12px 0 0; display: block; }
    .mini-album-content { padding: 0.5rem 0.6rem 0.6rem; }
    .mini-album-title { font-size: 0.95rem; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-album-sub { font-size: 0.8rem; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .section-divider { height: 1px; background: #2a2a2a; margin: 0.5rem 0; }

    @media (max-width: 900px) {
      .location-body { grid-template-columns: 1fr; }
    }

    /* Full-bleed album scroller on small screens */
    @media (max-width: 900px) {
      .albums-scroller {
        width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
        /* Account for page (1rem) + section (1rem) padding so first card aligns */
        padding-left: 2rem;
        padding-right: 2rem;
      }
      /* If only one album card, don't full-bleed; keep inline with content */
      .albums-scroller.single {
        width: 100%;
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }
    }

    /* Desktop spacing: ensure margin between share icons row and approach panel
       when approach is moved under the map column */
    @media (min-width: 901px) {
      .map-col > .location-approach { margin-top: 0.6rem; }
      /* Allow album glow to extend beyond the left/right edges without shifting layout */
      .albums-scroller {
        /* Desktop: full-bleed to the right, with safe glow space on the left */
        width: calc(100% + 3rem);  /* +2rem on right, +1rem on left */
        margin-right: -2rem;        /* bleed to viewport edge (page 1rem + section 1rem) */
        padding-right: 2rem;        /* keep hover/glow visible at viewport edge */
        margin-left: -1rem;         /* offset left by section padding */
        padding-left: 1rem;         /* allow glow on first card without clipping */
      }
      /* If only one album card, keep inline with content (no bleed) */
      .albums-scroller.single {
        width: 100%;
        margin-right: 0;
        padding-right: 0;
        margin-left: 0;
        padding-left: 0;
      }
    }

    /* Location Attributes */
    .location-attributes { background: transparent; border: none; border-radius: 0; padding: 0; color: #ddd; }
    .location-attributes .heading { display: none; }
    .attributes-list { display: flex; flex-wrap: wrap; gap: 0.25rem; contain: layout paint; will-change: transform; }
    .attribute-badge {
      display: inline-flex; align-items: center; gap: 0;
      background: #333;
      color: #e0e0e0;
      border: 1px solid #444; border-radius: 6px;
      padding: 0.2em 0.55em; font-size: 0.85em; font-weight: 600; line-height: 1;
      box-shadow: none;
      transition: background 120ms ease, border-color 120ms ease;
      position: relative;
    }
    .attribute-badge .attr-content { display: inline-flex; align-items: center; gap: 0.35rem; }
    .attribute-badge:hover { background: #3a3a3a; border-color: #555; }
    .attribute-badge .attr-key { color: #e0e0e0; letter-spacing: 0.1px; }
    .attribute-badge .attr-sep { display: none; }
    .attribute-badge .attr-value { color: #00b894; background: rgba(0,184,148,0.15); border: 1px solid rgba(0,184,148,0.4); border-radius: 6px; padding: 0.06em 0.28em; font-weight: 600; }
    .attribute-badge .attr-value.count { background: linear-gradient(135deg, rgba(3,218,198,0.22), rgba(0,184,148,0.18)); }

    /* Remove chip for edit mode (inline at left, expands on hover to push content) */
    .attribute-badge .attr-remove {
      display: inline-flex;
      width: 0; height: 16px;
      overflow: hidden;
      align-items: center; justify-content: center;
      border: 0 solid #444; background: #2b2b2b; color: #bbb;
      border-radius: 50%; font-size: 11px; line-height: 1; cursor: pointer; padding: 0;
      opacity: 0; pointer-events: none;
      margin-right: 0;
      transition: width 120ms ease, margin-right 120ms ease, opacity 120ms ease, border-width 120ms ease, background 120ms ease, color 120ms ease;
      will-change: width, opacity, margin-right;
    }
    .attribute-badge .attr-remove:hover { background: #333; color: #fff; }
    .location-section.editing .attribute-badge:hover .attr-remove {
      width: 16px; margin-right: 6px; opacity: 1; pointer-events: auto; border-width: 1px;
    }

    .attributes-editor { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 0.6rem; }
    .attributes-badges-container { display: flex; flex-wrap: wrap; gap: 0.45rem; }
    .attribute-badge-toggleable {
      cursor: pointer; user-select: none;
      background: linear-gradient(180deg, #1c1c1c, #232323);
      color: #cfcfcf; border: 1px solid #333; border-radius: 999px;
      padding: 0.3rem 0.65rem; font-size: 0.8rem; line-height: 1;
      transition: transform 90ms ease, color 120ms ease, background 120ms ease;
    }
    .attribute-badge-toggleable:hover { transform: translateY(-0.5px); }
    .attribute-badge-toggleable.selected { background: linear-gradient(135deg, #1f2a29, #1c222b); color: #03dac6; border-color: #03dac6; box-shadow: 0 0 0 1px rgba(3,218,198,0.35) inset, 0 4px 14px rgba(3,218,198,0.12); }
    .add-attribute-input { width: 100%; padding: 0.55rem 0.7rem; border-radius: 10px; border: 1px solid #444; background: #1b1b1b; color: #fff; }

    /* Markers editor minor UI tweaks */
    .markers-add-row { display: flex; gap: 0.5rem; align-items: stretch; }
    /* Match input vertical padding for equal height */
    .markers-add-row .emoji-picker-btn,
    .markers-add-row .place-btn { padding: 0.55rem 0.6rem; }
    .emoji-picker-btn { min-width: 2.2rem; display: inline-flex; align-items: center; justify-content: center; }
    .place-btn { letter-spacing: 0.2px; }
    .markers-list .marker-row { display: grid; grid-template-columns: auto 1fr auto auto auto; align-items: center; gap: 0.4rem; }
    .markers-list .marker-label { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
    .markers-list .marker-count { background: rgba(3,218,198,0.22); color: #03dac6; border: 1px solid rgba(3,218,198,0.4); border-radius: 999px; padding: 0.1rem 0.4rem; font-size: 0.72rem; white-space: nowrap; }
  </style>
</head>
<body>
  <nav>
    <a href="/crew">Crew</a>
    <a href="/albums">Albums</a>
    <a href="/locations" class="active">Locations</a>
    <a href="/knowledge">Knowledge</a>
    <a href="/memes">Memes</a>
  </nav>
  <main class="page-fade locations-page">
    <div id="locations-header" class="locations-header">
      <div id="locations-count" class="locations-count"></div>
    </div>
    <div id="locations-container"></div>
  </main>

  <!-- Search FAB and Popup -->
  <button id="locations-search-fab" class="search-fab" title="Search locations">
    <span class="search-fab-icon">🔎</span>
  </button>
  <div id="locations-search-overlay" class="search-popup-overlay"></div>
  <div id="locations-search-popup" class="search-popup" role="dialog" aria-modal="true" aria-labelledby="locations-search-title">
    <div class="search-popup-header">
      <div id="locations-search-title" class="search-popup-title">Search Locations</div>
      <button id="locations-search-close" class="search-popup-close" aria-label="Close">×</button>
    </div>
    <div class="search-popup-content">
      <input id="locations-filter" class="search-input" type="text" placeholder="Type to filter locations..." aria-label="Search locations">
    </div>
    <div class="search-popup-footer">
      <button id="locations-search-clear" class="search-action-btn">Clear</button>
      <button id="locations-search-done" class="search-action-btn">Done</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Load auth early so the user header renders ASAP -->
  <script src="/static/js/auth.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <script src="/static/js/locations.js"></script>
  <!-- PWA and Notification Management -->
  <script src="/static/js/pwa-manager.js"></script>
  <script src="/static/js/notification-health-manager.js"></script>
  <script src="/static/js/notifications.js"></script>
  <script src="/static/js/cache-manager.js"></script>
  <script src="/static/js/update-notifier.js"></script>
  <a href="/privacy" class="privacy-link" title="Privacy Policy">
    <span class="privacy-link-icon">🔒</span>
    <span class="privacy-link-text">Privacy</span>
  </a>
</body>
</html>


