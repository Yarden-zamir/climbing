<!DOCTYPE html>
<html lang="en">

<head>
	<link id="favicon" rel="icon" type="image/x-icon" href="/static/favicon/favicon.ico">
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="description" content="Browse and share climbing photo albums from our community. Upload, organize, and discover amazing climbing moments and achievements." />
	<title>Albums</title>
	
	<!-- PWA manifest -->
	<link rel="manifest" href="/static/manifest.json">
	<meta name="theme-color" content="#4285f4">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="Climbing">
	
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
			<link rel="stylesheet" href="/static/css/styles.css?v=1.1" />
	<!-- Cropper.js CSS -->
	    <link rel="stylesheet" href="/static/css/cropper.min.css">
	<style>
		/* Floating Action Button */
		.filter-fab {
			position: fixed;
			bottom: 2rem;
			right: 2rem;
			width: 64px;
			height: 64px;
			background: linear-gradient(135deg, #bb86fc 0%, #6200ea 100%);
			border: none;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 6px 20px rgba(187, 134, 252, 0.4);
			z-index: 1000;
			overflow: hidden;
		}
		
		.filter-fab:hover {
			transform: scale(1.1);
			box-shadow: 0 8px 30px rgba(187, 134, 252, 0.6);
		}
		
		.filter-fab:active {
			transform: scale(0.95);
		}
		
		.filter-fab.active {
			background: linear-gradient(135deg, #03dac6 0%, #018786 100%);
		}
		
		.filter-fab::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
			transition: left 0.5s;
		}
		
		.filter-fab:hover::before {
			left: 100%;
		}
		
		.filter-fab-icon {
			font-size: 1.5rem;
			transition: transform 0.3s ease;
			color: white;
			z-index: 2;
		}
		
		.filter-fab.active .filter-fab-icon {
			transform: rotate(45deg);
		}
		

		
		/* Filter Popup */
		.filter-popup-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			z-index: 999;
			pointer-events: none;
			display: none;
		}
		
		.filter-popup-overlay.active {
			pointer-events: auto;
			display: block;
		}
		
		.filter-popup {
			position: fixed;
			bottom: 6rem;
			right: 2rem;
			width: 400px;
			max-width: calc(100vw - 4rem);
			max-height: calc(100vh - 12rem);
			background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
			border-radius: 20px;
			border: 1px solid #333;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
			backdrop-filter: blur(20px);
			transform: translateY(20px) scale(0.9);
			opacity: 0;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			overflow: hidden;
			z-index: 1001;
			pointer-events: none;
			visibility: hidden;
		}
		
		.filter-popup.active {
			transform: translateY(0) scale(1);
			opacity: 1;
			pointer-events: auto;
			visibility: visible;
		}
		
		.filter-popup-header {
			padding: 1.5rem;
			border-bottom: 1px solid #333;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		
		.filter-popup-title {
			font-size: 1.2rem;
			font-weight: 700;
			color: #fff;
			margin: 0;
			background: linear-gradient(90deg, #bb86fc, #03dac6);
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}
		
		.filter-popup-close {
			background: none;
			border: none;
			color: #888;
			font-size: 1.5rem;
			cursor: pointer;
			padding: 0.5rem;
			border-radius: 50%;
			transition: all 0.2s ease;
		}
		
		.filter-popup-close:hover {
			background: #333;
			color: #fff;
		}
		
		.filter-popup-content {
			padding: 1.5rem;
			max-height: calc(100vh - 26rem);
			overflow-y: auto;
		}
		
		.filter-popup-footer {
			padding: 1.5rem;
			border-top: 1px solid #333;
			display: flex;
			justify-content: center;
			background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
			border-radius: 0 0 20px 20px;
		}
		
		.filter-controls {
			display: flex;
			gap: 0.7rem;
			margin-bottom: 1.5rem;
			flex-wrap: wrap;
		}
		
		.filter-btn {
			background: linear-gradient(135deg, #333 0%, #444 100%);
			border: 1px solid #555;
			color: #e0e0e0;
			padding: 0.6rem 1.2rem;
			border-radius: 25px;
			cursor: pointer;
			font-size: 0.9rem;
			font-weight: 500;
			transition: all 0.3s ease;
			position: relative;
			overflow: hidden;
		}
		
		.filter-btn::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(187, 134, 252, 0.3), transparent);
			transition: left 0.3s;
		}
		
		.filter-btn:hover {
			background: linear-gradient(135deg, #444 0%, #555 100%);
			border-color: #bb86fc;
			transform: translateY(-1px);
			box-shadow: 0 4px 15px rgba(187, 134, 252, 0.2);
		}
		
		.filter-btn:hover::before {
			left: 100%;
		}
		
		.people-filters {
			display: grid;
			grid-template-columns: 1fr;
			gap: 0.6rem;
			margin-bottom: 1rem;
		}
		
		.person-filter {
			display: flex;
			align-items: center;
			gap: 0.8rem;
			padding: 0.8rem 1rem;
			background: linear-gradient(135deg, #252525 0%, #1a1a1a 100%);
			border-radius: 12px;
			border: 1px solid #333;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			cursor: pointer;
			position: relative;
			overflow: hidden;
		}
		
		.person-filter::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: linear-gradient(135deg, rgba(187, 134, 252, 0.1) 0%, rgba(3, 218, 198, 0.1) 100%);
			opacity: 0;
			transition: opacity 0.3s ease;
		}
		
		.person-filter:hover::before,
		.person-filter.checked::before {
			opacity: 1;
		}
		
		.person-filter:hover {
			transform: translateX(4px);
			border-color: #bb86fc;
			box-shadow: 0 4px 15px rgba(187, 134, 252, 0.2);
		}
		
		.person-filter.checked {
			border-color: #03dac6;
			background: linear-gradient(135deg, #1a3a35 0%, #0d2d28 100%);
		}
		
		.person-filter.checked:hover {
			border-color: #03dac6;
		}
		
		.person-filter input[type="checkbox"] {
			display: none;
		}
		
		.person-filter .person-face {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			object-fit: cover;
			border: 2px solid #555;
			transition: all 0.3s ease;
			z-index: 2;
			position: relative;
		}
		
		.person-filter.checked .person-face {
			border-color: #03dac6;
			box-shadow: 0 0 0 2px rgba(3, 218, 198, 0.3);
		}
		
		.person-filter span {
			flex: 1;
			cursor: pointer;
			color: #e0e0e0;
			font-size: 0.95rem;
			font-weight: 500;
			z-index: 2;
			position: relative;
			transition: color 0.3s ease;
		}
		
		.person-filter.checked span {
			color: #03dac6;
		}
		
		.filter-status {
			padding: 1rem;
			background: linear-gradient(135deg, #1a3a35 0%, #0d2d28 100%);
			border-radius: 12px;
			border: 1px solid #03dac6;
			color: #03dac6;
			font-size: 0.9rem;
			text-align: center;
			font-weight: 500;
			box-shadow: 0 0 15px rgba(3, 218, 198, 0.2);
		}
		
		/* Add Album FAB */
		.add-album-fab {
			position: fixed;
			bottom: 2rem;
			right: 5rem;
			width: 64px;
			height: 64px;
			background: linear-gradient(135deg, #ffae52 0%, #ff6b35 100%);
			border: none;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 6px 20px rgba(255, 174, 82, 0.4);
			z-index: 1000;
			overflow: hidden;
		}
		
		.add-album-fab:hover {
			transform: scale(1.1);
			box-shadow: 0 8px 30px rgba(255, 174, 82, 0.6);
		}
		
		.add-album-fab:active {
			transform: scale(0.95);
		}
		
		.add-album-fab::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
			transition: left 0.5s;
		}
		
		.add-album-fab:hover::before {
			left: 100%;
		}
		
		.add-album-fab-icon {
			font-size: 1.5rem;
			transition: transform 0.3s ease;
			color: white;
			z-index: 2;
		}
		
		.add-album-fab.active .add-album-fab-icon {
			transform: rotate(45deg);
		}

		/* Edit Album FAB */
		.edit-album-fab {
			position: fixed;
			bottom: 2rem;
			right: 8rem;
			width: 64px;
			height: 64px;
			background: #03dac6;
			border: none;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 6px 20px rgba(3, 218, 198, 0.4);
			z-index: 1000;
			overflow: hidden;
		}
		
		.edit-album-fab:hover {
			transform: scale(1.1);
			box-shadow: 0 8px 30px rgba(3, 218, 198, 0.6);
		}
		
		.edit-album-fab:active {
			transform: scale(0.95);
		}
		
		.edit-album-fab.active {
			background: #03dac6;
			box-shadow: 0 6px 20px rgba(3, 218, 198, 0.4);
		}
		
		.edit-album-fab::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
			transition: left 0.5s;
		}
		
		.edit-album-fab:hover::before {
			left: 100%;
		}
		
		.edit-album-fab-icon {
			font-size: 1.5rem;
			transition: transform 0.3s ease;
			color: white;
			z-index: 2;
		}
		
		.edit-album-fab.active .edit-album-fab-icon {
			transform: rotate(180deg);
		}

		/* Add Album Modal */
		.add-album-modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.8);
			z-index: 2000;
			display: none;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(5px);
		}
		
		.add-album-modal-overlay.active {
			display: flex;
		}
		
		.add-album-modal {
			background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
			border-radius: 20px;
			border: 1px solid #333;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			transform: scale(0.9);
			opacity: 0;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		.add-album-modal.active {
			transform: scale(1);
			opacity: 1;
		}
		
		.add-album-modal-header {
			padding: 2rem;
			border-bottom: 1px solid #333;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		
		.add-album-modal-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: #fff;
			margin: 0;
			background: linear-gradient(90deg, #ffae52, #ff6b35);
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}
		
		.add-album-modal-close {
			background: none;
			border: none;
			color: #888;
			font-size: 2rem;
			cursor: pointer;
			padding: 0.5rem;
			border-radius: 50%;
			transition: all 0.2s ease;
		}
		
		.add-album-modal-close:hover {
			background: #333;
			color: #fff;
		}
		
		.add-album-form {
			padding: 2rem;
		}
		
		.form-group {
			margin-bottom: 1.5rem;
		}
		
		.form-label {
			display: block;
			color: #fff;
			font-weight: 600;
			margin-bottom: 0.5rem;
			font-size: 1rem;
		}
		
		.form-input {
			width: 100%;
			padding: 1rem;
			background: #333;
			border: 2px solid #444;
			border-radius: 12px;
			color: #fff;
			font-size: 1rem;
			transition: all 0.3s ease;
			box-sizing: border-box;
		}
		
		.form-input:focus {
			outline: none;
			border-color: #ffae52;
			box-shadow: 0 0 0 3px rgba(255, 174, 82, 0.2);
		}
		
		.form-input.error {
			border-color: #cf6679;
			box-shadow: 0 0 0 3px rgba(207, 102, 121, 0.2);
		}
		
		.form-error {
			color: #cf6679;
			font-size: 0.9rem;
			margin-top: 0.5rem;
		}
		
		.form-success {
			color: #03dac6;
			font-size: 0.9rem;
			margin-top: 0.5rem;
		}
		
		.crew-selector {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 0.5rem;
			max-height: 200px;
			overflow-y: auto;
			padding: 1rem;
			background: #222;
			border-radius: 12px;
			border: 2px solid #444;
		}
		
		.crew-option {
			display: flex;
			align-items: center;
			gap: 0.7rem;
			padding: 0.5rem;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s ease;
			background: transparent;
		}
		
		.crew-option:hover {
			background: #333;
		}
		
		.crew-option.selected {
			background: #ffae5222;
			border: 2px solid #ffae52;
		}
		
		.crew-option input[type="checkbox"] {
			display: none;
		}
		
		.crew-option .crew-face {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			object-fit: cover;
			border: 2px solid #555;
		}
		
		.crew-option.selected .crew-face {
			border-color: #ffae52;
		}
		
		.crew-option-name {
			color: #e0e0e0;
			font-size: 0.95rem;
			font-weight: 500;
		}
		
		.crew-option.selected .crew-option-name {
			color: #ffae52;
		}
		
		.new-person-form {
			background: #222;
			border-radius: 12px;
			padding: 1rem;
			margin-top: 1rem;
			border: 2px solid #444;
		}
		
		.new-person-input {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 1rem;
		}
		
		.new-person-input input {
			flex: 1;
		}
		
		.skills-input-container {
			position: relative;
			margin-bottom: 1rem;
		}
		
		.skills-input {
			width: 100%;
			padding: 0.7rem;
			background: #333;
			border: 2px solid #444;
			border-radius: 8px;
			color: #fff;
			font-size: 0.95rem;
		}
		
		.skills-input:focus {
			outline: none;
			border-color: #ffae52;
		}
		
		.skills-autocomplete {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #333;
			border: 2px solid #444;
			border-top: none;
			border-radius: 0 0 8px 8px;
			max-height: 150px;
			overflow-y: auto;
			z-index: 1000;
			display: none;
		}
		
		.skills-autocomplete-item {
			padding: 0.7rem;
			cursor: pointer;
			color: #e0e0e0;
			transition: background 0.2s ease;
		}
		
		.skills-autocomplete-item:hover,
		.skills-autocomplete-item.selected {
			background: #ffae52;
			color: #1a1a1a;
		}
		

		
		.image-upload-container {
			margin-bottom: 1rem;
		}
		
		.image-upload-area {
			border: 2px dashed #444;
			border-radius: 8px;
			padding: 1.5rem;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s ease;
			background: #333;
		}
		
		.image-upload-area:hover {
			border-color: #ffae52;
			background: #383838;
		}
		
		.image-upload-area.dragover {
			border-color: #ffae52;
			background: #ffae5222;
		}
		
		.image-preview {
			max-width: 100px;
			max-height: 100px;
			border-radius: 50%;
			object-fit: cover;
			border: 3px solid #ffae52;
			margin-bottom: 0.5rem;
		}
		
		.upload-text {
			color: #ccc;
			font-size: 0.9rem;
		}
		
		.upload-file-input {
			display: none;
		}
		
		.add-person-btn {
			background: #ffae52;
			color: #1a1a1a;
			border: none;
			padding: 0.5rem 1rem;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 600;
			transition: all 0.2s ease;
		}
		
		.add-person-btn:hover {
			background: #ff9630;
		}
		
		.submit-btn {
			width: 100%;
			padding: 1rem;
			background: linear-gradient(135deg, #ffae52 0%, #ff6b35 100%);
			color: #1a1a1a;
			border: none;
			border-radius: 12px;
			font-size: 1.1rem;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s ease;
			margin-top: 1rem;
		}
		
		.submit-btn:hover:not(:disabled) {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(255, 174, 82, 0.4);
		}
		
		.submit-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		
		.album-preview {
			background: #222;
			border-radius: 12px;
			padding: 1rem;
			margin-top: 1rem;
			border: 2px solid #333;
		}
		
		.album-preview.loading {
			opacity: 0.6;
		}
		
		.album-preview-image {
			width: 100%;
			object-fit: cover;
			border-radius: 8px;
			margin-bottom: 1rem;
		}
		
		.album-preview-title {
			font-size: 1.2rem;
			font-weight: 600;
			color: #fff;
			margin-bottom: 0.5rem;
		}
		
		.album-preview-description {
			color: #ccc;
			font-size: 0.95rem;
			line-height: 1.4;
		}

		/* Edit Mode Overlay */
		.edit-mode-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(187, 134, 252, 0.1);
			z-index: 500;
			display: none;
			pointer-events: none;
		}
		
		.edit-mode-overlay.active {
			display: block;
		}
		
		.edit-mode-message {
			position: fixed;
			top: 2rem;
			left: 50%;
			transform: translateX(-50%);
			background: linear-gradient(135deg, #bb86fc 0%, #6200ea 100%);
			color: white;
			padding: 1rem 2rem;
			border-radius: 25px;
			font-weight: 600;
			font-size: 1.1rem;
			box-shadow: 0 8px 25px rgba(187, 134, 252, 0.4);
			z-index: 1001;
			display: none;
			animation: slideDown 0.3s ease-out;
		}
		
		.edit-mode-message.active {
			display: block;
		}
		
		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateX(-50%) translateY(-20px);
			}
			to {
				opacity: 1;
				transform: translateX(-50%) translateY(0);
			}
		}
		
		.album-card.edit-mode {
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		.album-card.edit-mode:hover {
			transform: translateY(-8px) scale(1.02);
			box-shadow: 0 12px 30px rgba(187, 134, 252, 0.3);
			border: 2px solid #bb86fc;
		}

		/* Edit Album Modal */
		.edit-album-modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.8);
			z-index: 2000;
			display: none;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(5px);
		}
		
		.edit-album-modal-overlay.active {
			display: flex;
		}
		
		.edit-album-modal {
			background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
			border-radius: 20px;
			border: 1px solid #333;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
			width: 90%;
			max-width: 600px;
			max-height: 90vh;
			overflow-y: auto;
			transform: scale(0.9);
			opacity: 0;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}
		
		.edit-album-modal.active {
			transform: scale(1);
			opacity: 1;
		}
		
		.edit-album-modal-header {
			padding: 2rem;
			border-bottom: 1px solid #333;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		
		.edit-album-modal-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: #fff;
			margin: 0;
			background: linear-gradient(90deg, #bb86fc, #03dac6);
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}
		
		.edit-album-modal-close {
			background: none;
			border: none;
			color: #888;
			font-size: 2rem;
			cursor: pointer;
			padding: 0.5rem;
			border-radius: 50%;
			transition: all 0.2s ease;
		}
		
		.edit-album-modal-close:hover {
			background: #333;
			color: #fff;
		}
		
		.edit-album-form {
			padding: 2rem;
		}
		
		.album-info {
			background: #222;
			border-radius: 12px;
			padding: 1rem;
			margin-bottom: 1.5rem;
			border: 2px solid #333;
		}
		
		.album-info-image {
			width: 100%;
			object-fit: cover;
			border-radius: 8px;
			margin-bottom: 1rem;
		}
		
		.album-info-title {
			font-size: 1.2rem;
			font-weight: 600;
			color: #fff;
			margin-bottom: 0.5rem;
		}
		
		.album-info-url {
			color: #bb86fc;
			font-size: 0.9rem;
			word-break: break-all;
		}

		/* Mobile adjustments */
		@media (max-width: 700px) {
			.filter-fab {
				bottom: 1.5rem;
				right: 1.5rem;
				width: 56px;
				height: 56px;
			}
			
			.filter-fab-icon {
				font-size: 1.3rem;
			}
			
			.add-album-fab {
				bottom: 1.5rem;
				right: 4rem;
				width: 56px;
				height: 56px;
			}
			
			.add-album-fab-icon {
				font-size: 1.3rem;
			}
			
			.edit-album-fab {
				bottom: 1.5rem;
				right: 6.5rem;
				width: 56px;
				height: 56px;
			}
			
			.edit-album-fab-icon {
				font-size: 1.3rem;
			}
			
			.filter-popup {
				bottom: 5rem;
				right: 1.5rem;
				left: 1.5rem;
				width: auto;
				max-width: none;
			}
			
			.filter-popup-content {
				padding: 1rem;
			}
			
			.filter-popup-header {
				padding: 1rem;
			}
			
			.add-album-modal {
				width: 95%;
				margin: 1rem;
			}
			
			.add-album-modal-header,
			.add-album-form {
				padding: 1.5rem;
			}
			
			.crew-selector {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>

<body>
	<nav>
		<a href="/crew">Crew</a>
		<a href="/albums" class="active">Albums</a>
		<a href="/knowledge">Knowledge</a>
		<a href="/memes">Memes</a>
	</nav>
	<main class="page-fade">
		<div id="albums-container" class="albums-grid">
			<!-- Album cards will be injected here by JavaScript -->
		</div>
		
		<!-- Floating Action Buttons -->
		<button class="filter-fab" id="filter-fab">
			<span class="filter-fab-icon">🔍</span>
		</button>
		
		<button class="add-album-fab" id="add-album-fab">
			<span class="add-album-fab-icon">➕</span>
		</button>
		
		<button class="edit-album-fab" id="edit-album-fab">
			<span class="edit-album-fab-icon">✏️</span>
		</button>
		
		<!-- Edit Mode Overlay -->
		<div class="edit-mode-overlay" id="edit-mode-overlay"></div>
		<div class="edit-mode-message" id="edit-mode-message">
			✏️ Click on an album to edit its crew members
		</div>
		
		<!-- Filter Popup Overlay -->
		<div class="filter-popup-overlay" id="filter-popup-overlay"></div>
		
		<!-- Filter Popup -->
		<div class="filter-popup" id="filter-popup">
			<div class="filter-popup-header">
				<h2 class="filter-popup-title">Filter by People</h2>
				<button class="filter-popup-close" id="filter-popup-close">×</button>
			</div>
			<div class="filter-popup-content">
				<div id="people-filters" class="people-filters">
					<!-- People checkboxes will be populated here -->
				</div>
				<div id="filter-status" class="filter-status" style="display: none;">
					<!-- Status message will appear here -->
				</div>
			</div>
			<div class="filter-popup-footer">
				<button class="filter-btn" id="clear-all-btn">🗑️ Clear All</button>
			</div>
		</div>
		
		<!-- Add Album Modal -->
		<div class="add-album-modal-overlay" id="add-album-modal-overlay">
			<div class="add-album-modal" id="add-album-modal">
				<div class="add-album-modal-header">
					<h2 class="add-album-modal-title">Add New Album</h2>
					<button class="add-album-modal-close" id="add-album-modal-close">×</button>
				</div>
				<form class="add-album-form" id="add-album-form">
					<div class="form-group">
						<label class="form-label" for="album-url">Google Photos Album URL</label>
						<input 
							type="url" 
							id="album-url" 
							class="form-input" 
							placeholder="https://photos.app.goo.gl/..."
							required
						>
						<div id="url-error" class="form-error" style="display: none;"></div>
						<div id="url-success" class="form-success" style="display: none;"></div>
					</div>
					
					<div id="album-preview" class="album-preview" style="display: none;">
						<!-- Album preview will be populated here -->
					</div>
					
					<div class="form-group">
						<label class="form-label">Select Crew Members</label>
						<div id="crew-selector" class="crew-selector">
							<!-- Crew options will be populated here -->
						</div>
					</div>
					
					<div class="form-group">
						<label class="form-label">Add New Person (Optional)</label>
						<div class="new-person-form" id="new-person-form" style="display: none;">
							<div class="new-person-input">
								<input 
									type="text" 
									id="new-person-name" 
									class="form-input" 
									placeholder="Full name"
								>
							</div>
							
							<div class="image-upload-container">
								<label class="form-label">Profile Image</label>
								<div class="image-upload-area" id="image-upload-area">
									<input type="file" id="image-upload-input" class="upload-file-input" accept="image/*">
									<div id="upload-content">
										<div class="upload-text">
											📷 Click or drag to upload profile image<br>
											<small>(JPG, PNG, max 5MB)</small>
										</div>
									</div>
								</div>
							</div>
							
							<div class="skills-input-container">
								<label class="form-label">Skills</label>
								<div class="skills-badges-container" id="skills-badges-container">
									<!-- Available skills badges will appear here -->
								</div>
							</div>
							
							<div style="display: flex; gap: 0.5rem;">
								<button type="button" class="add-person-btn" id="add-person-btn">Add Person</button>
								<button type="button" class="add-person-btn" id="cancel-person-btn" style="background: #666;">Cancel</button>
							</div>
						</div>
						
						<button type="button" class="add-person-btn" id="show-new-person-btn">+ Add New Person</button>
						
						<div id="new-people-list" style="margin-top: 1rem;">
							<!-- New people will be listed here -->
						</div>
					</div>
					
					<button type="submit" class="submit-btn" id="submit-album-btn" disabled>
						Add Album
					</button>
					
					<div id="submission-status" style="margin-top: 1rem; text-align: center;">
						<!-- Submission status will appear here -->
					</div>
				</form>
			</div>
		</div>
		
		<!-- Edit Album Modal -->
		<div class="edit-album-modal-overlay" id="edit-album-modal-overlay">
			<div class="edit-album-modal" id="edit-album-modal">
				<div class="edit-album-modal-header">
					<h2 class="edit-album-modal-title">Edit Album Crew</h2>
					<button class="edit-album-modal-close" id="edit-album-modal-close">×</button>
				</div>
				<form class="edit-album-form" id="edit-album-form">
					<div class="album-info" id="edit-album-info">
						<!-- Album info will be populated here -->
					</div>
					
					<div class="form-group">
						<label class="form-label">Select Crew Members</label>
						<div id="edit-crew-selector" class="crew-selector">
							<!-- Crew options will be populated here -->
						</div>
					</div>
					
					<div class="form-group">
						<label class="form-label">Add New Person (Optional)</label>
						<div class="new-person-form" id="edit-new-person-form" style="display: none;">
							<div class="new-person-input">
								<input 
									type="text" 
									id="edit-new-person-name" 
									class="form-input" 
									placeholder="Full name"
								>
							</div>
							<div class="image-upload-container">
								<label class="form-label">Profile Image</label>
								<div class="image-upload-area" id="edit-image-upload-area">
									<input type="file" id="edit-image-upload-input" class="upload-file-input" accept="image/*">
									<div id="edit-upload-content">
										<div class="upload-text">
											📷 Click or drag to upload profile image<br>
											<small>(JPG, PNG, max 5MB)</small>
										</div>
									</div>
								</div>
							</div>
							<div class="skills-input-container">
								<label class="form-label">Skills</label>
								<div class="skills-badges-container" id="edit-album-skills-badges-container">
									<!-- Available skills badges will appear here -->
								</div>
							</div>
							<div style="display: flex; gap: 0.5rem;">
								<button type="button" class="add-person-btn" id="edit-add-person-btn">Add Person</button>
								<button type="button" class="add-person-btn" id="edit-cancel-person-btn" style="background: #666;">Cancel</button>
							</div>
						</div>
						<button type="button" class="add-person-btn" id="edit-show-new-person-btn">+ Add New Person</button>
						<div id="edit-new-people-list" style="margin-top: 1rem;"></div>
					</div>
					
					<div style="gap: 1rem;">
						<button type="submit" class="submit-btn" id="edit-submit-btn" style="flex: 1;">
						Update Crew
					</button>
						<button type="button" class="submit-btn" id="delete-album-btn" style="
							background: linear-gradient(135deg, #cf6679 0%, #b71c1c 100%);
							color: white;
							padding: 0.75rem 1rem;
							font-size: 0.9rem;
						">
							🗑️ Delete
						</button>
					</div>
					
					<div id="edit-submission-status" style="margin-top: 1rem; text-align: center;">
						<!-- Submission status will appear here -->
					</div>
				</form>
			</div>
		</div>
	</main>
	
	<!-- Image Cropping Modal -->
	<div class="crop-modal-overlay" id="crop-modal-overlay">
		<div class="crop-modal" id="crop-modal">
			<div class="crop-modal-header">
				<h2 class="crop-modal-title">Crop Profile Image</h2>
				<button class="crop-modal-close" id="crop-modal-close">×</button>
			</div>
			<div class="crop-modal-body">
				<div class="crop-container">
					<img id="crop-image" class="crop-image" alt="Image to crop">
				</div>
			</div>
			<div class="crop-modal-footer">
				<button type="button" class="crop-btn crop-btn-cancel" id="crop-cancel-btn">Cancel</button>
				<button type="button" class="crop-btn crop-btn-confirm" id="crop-confirm-btn">Crop & Use</button>
			</div>
		</div>
	</div>
	
	<!-- Cropper.js JavaScript -->
	<script src="/static/js/cropper.min.js"></script>
	<script src="static/js/albums.js"></script>
	<!-- PWA and Notification Management -->
	<script src="/static/js/pwa-manager.js"></script>
	<script src="/static/js/notification-health-manager.js"></script>
	<script src="/static/js/notifications.js"></script>
	<script>
		// Global variables for modals
		let editAlbumCurrentPersonImage = null;
		let addAlbumCurrentPersonImage = null;
		
		// Global function to handle cropped image result for edit album modal
		window.applyImageToEditAlbum = function(croppedFile, dataUrl) {
			editAlbumCurrentPersonImage = croppedFile;
			const uploadContent = document.getElementById('edit-upload-content');
			if (uploadContent) {
				uploadContent.innerHTML = `
					<img src="${dataUrl}" class="image-preview" alt="Preview">
					<div class="upload-text">
						✅ Image uploaded (cropped)<br>
						<small>Click to change</small>
					</div>
				`;
			}
		};
		
		// Global function to handle cropped image result for add album modal
		window.applyImageToAdd = function(croppedFile, dataUrl) {
			addAlbumCurrentPersonImage = croppedFile;
			const uploadContent = document.getElementById('upload-content');
			if (uploadContent) {
				uploadContent.innerHTML = `
					<img src="${dataUrl}" class="image-preview" alt="Preview">
					<div class="upload-text">
						✅ Image uploaded (cropped)<br>
						<small>Click to change</small>
					</div>
				`;
			}
		};

		document.addEventListener("DOMContentLoaded", () => {
			document.querySelectorAll('nav a').forEach(link => {
				link.addEventListener('click', function (e) {
					const href = this.getAttribute('href');
					if (href && !href.startsWith('#') && !this.classList.contains('active')) {
						e.preventDefault();
						const main = document.querySelector('main.page-fade');
						main.classList.add('fade-out');
						setTimeout(() => {
							window.location.href = href;
						}, 100);
					}
				});
			});
			
			// Initialize add album functionality
			initAddAlbumModal();
			
			// Check for PWA shortcut action parameter
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.get('action') === 'add') {
				// Wait a moment for the page to fully load, then open the add album modal
				setTimeout(() => {
					const addAlbumFab = document.getElementById('add-album-fab');
					if (addAlbumFab) {
						addAlbumFab.click();
					}
				}, 500);
			}
			
			// Initialize edit album functionality
			initEditAlbumModal();
			
			// Function to smoothly update just one album's crew display
			window.refreshSingleAlbumCrew = async function(albumUrl) {
				try {
					// Fetch updated enriched albums data  
					const response = await fetch("/api/albums/enriched?_t=" + Date.now());
					if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					
					const enrichedAlbums = await response.json();
					
					// Find the updated album data - try both metadata.url and url
					const updatedAlbum = enrichedAlbums.find(album => 
						(album.metadata && album.metadata.url === albumUrl) || 
						album.url === albumUrl
					);
					
					if (!updatedAlbum) {
						return;
					}
					
					// Find the album card on the page
					const albumCard = document.querySelector(`[data-album-url="${albumUrl}"]`);
					if (!albumCard) {
						return;
					}
					
					// Get the correct metadata
					const newMetadata = updatedAlbum.metadata || updatedAlbum;
					
					// Force update regardless of perceived changes
					forceUpdateAlbumCrewDisplay(albumCard, newMetadata);
					
				} catch (error) {
					window.location.reload();
				}
			};
			
			// Force update album crew display (no change detection)
			function forceUpdateAlbumCrewDisplay(albumCard, newMetadata) {
				// Always remove any existing crew stack
				const existingCrewStack = albumCard.querySelector('.album-crew-stack');
				
				if (existingCrewStack) {
					existingCrewStack.remove();
				}
				
				// Always add new crew stack with animation
				if (newMetadata.crew && Array.isArray(newMetadata.crew) && newMetadata.crew.length > 0) {
					addNewCrewStack(albumCard, newMetadata);
				}
				
				// Always update metadata
				albumCard.albumMeta = newMetadata;
			}
			
			function addNewCrewStack(albumCard, metadata) {
				const faceStack = document.createElement('div');
				faceStack.className = 'album-crew-stack';
				
				// Initially hidden for animation
				faceStack.style.opacity = '0';
				faceStack.style.transform = 'scale(0.8)';
				faceStack.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
				
				// Render the new crew faces
				metadata.crew.forEach((climber, index) => {
					const climberName = climber.name;
					const isNew = climber.is_new;

					const faceLink = document.createElement('a');
					faceLink.href = `/crew?highlight=${encodeURIComponent(climberName)}`;
					faceLink.className = 'album-crew-face-link';
					faceLink.title = climberName;
					faceLink.tabIndex = 0;
					
					const faceImg = document.createElement('img');
					faceImg.src = climber.image_url || `/redis-image/climber/${encodeURIComponent(climberName)}/face`;
					faceImg.alt = climberName;
					faceImg.className = `album-crew-face${isNew ? ' new-climber' : ''}`;
					
					faceLink.appendChild(faceImg);
					faceStack.appendChild(faceLink);
				});
				
				albumCard.appendChild(faceStack);
				
				// Animate in the new crew stack
				setTimeout(() => {
					faceStack.style.opacity = '1';
					faceStack.style.transform = 'scale(1)';
				}, 50);
				
				// Add a subtle highlight effect to show the change
				albumCard.style.transition = 'box-shadow 0.5s ease-out';
				albumCard.style.boxShadow = '0 8px 25px rgba(3, 218, 198, 0.4)';
				setTimeout(() => {
					albumCard.style.boxShadow = '';
				}, 2000);
			}
		});
		
		// Add Album Modal Functionality
		function initAddAlbumModal() {
			const addAlbumFab = document.getElementById('add-album-fab');
			const modalOverlay = document.getElementById('add-album-modal-overlay');
			const modal = document.getElementById('add-album-modal');
			const closeBtn = document.getElementById('add-album-modal-close');
			const form = document.getElementById('add-album-form');
			const urlInput = document.getElementById('album-url');
			const submitBtn = document.getElementById('submit-album-btn');
			
			let crewData = [];
			let selectedCrew = new Set();
			let newPeople = [];
			let urlValidationTimeout;
			let allSkills = [];
			let selectedSkills = [];
			
			// Fetch crew data and skills
			Promise.all([
				fetch('/api/crew').then(r => r.json()),
				fetch('/api/skills').then(r => r.json())
			]).then(([crew, skills]) => {
				crewData = crew;
				allSkills = skills;
				populateCrewSelector();
				initNewPersonForm();
				// Trigger initial render of skills badges
				const skillsBadgesContainer = document.getElementById('skills-badges-container');
				if (skillsBadgesContainer) {
					skillsBadgesContainer.innerHTML = allSkills.map(skill => `
						<div class="skill-badge-toggleable ${selectedSkills.includes(skill) ? 'selected' : ''}" data-skill="${skill}">${skill}</div>
					`).join('');
				}
			});
			
			// Open modal
			addAlbumFab.addEventListener('click', () => {
				modalOverlay.classList.add('active');
				setTimeout(() => modal.classList.add('active'), 50);
			});
			
			// Close modal
			const closeModal = () => {
				modal.classList.remove('active');
				setTimeout(() => {
					modalOverlay.classList.remove('active');
					resetForm();
				}, 300);
			};
			
			closeBtn.addEventListener('click', closeModal);
			modalOverlay.addEventListener('click', (e) => {
				if (e.target === modalOverlay) closeModal();
			});
			
			// URL validation
			urlInput.addEventListener('input', () => {
				clearTimeout(urlValidationTimeout);
				const url = urlInput.value.trim();
				
				if (!url) {
					hideUrlFeedback();
					updateSubmitButton();
					return;
				}
				
				urlValidationTimeout = setTimeout(() => validateUrl(url), 500);
			});
			
			async function validateUrl(url) {
				showUrlLoading();
				
				try {
					const response = await fetch(`/api/albums/validate-url?url=${encodeURIComponent(url)}`);
					const data = await response.json();
					
					if (data.valid) {
						if (data.exists) {
							showUrlError('This album already exists in the collection');
						} else if (data.title) {
							showUrlSuccess('Album found and accessible!');
							showAlbumPreview(data);
						} else {
							showUrlError('Album metadata could not be loaded. Please check the URL.');
						}
					} else {
						showUrlError(data.error || 'Invalid URL');
					}
				} catch (error) {
					showUrlError('Failed to validate URL');
				}
				
				updateSubmitButton();
			}
			
			function showUrlLoading() {
				const errorEl = document.getElementById('url-error');
				const successEl = document.getElementById('url-success');
				errorEl.style.display = 'none';
				successEl.style.display = 'block';
				successEl.textContent = 'Validating...';
				successEl.style.color = '#ffae52';
			}
			
			function showUrlError(message) {
				const errorEl = document.getElementById('url-error');
				const successEl = document.getElementById('url-success');
				urlInput.classList.add('error');
				urlInput.classList.remove('success');
				errorEl.textContent = message;
				errorEl.style.display = 'block';
				successEl.style.display = 'none';
				hideAlbumPreview();
			}
			
			function showUrlSuccess(message) {
				const errorEl = document.getElementById('url-error');
				const successEl = document.getElementById('url-success');
				urlInput.classList.remove('error');
				urlInput.classList.add('success');
				successEl.textContent = message;
				successEl.style.display = 'block';
				successEl.style.color = '#03dac6';
				errorEl.style.display = 'none';
			}
			
			function hideUrlFeedback() {
				const errorEl = document.getElementById('url-error');
				const successEl = document.getElementById('url-success');
				urlInput.classList.remove('error', 'success');
				errorEl.style.display = 'none';
				successEl.style.display = 'none';
				hideAlbumPreview();
			}
			
			function showAlbumPreview(metadata) {
				const preview = document.getElementById('album-preview');
				const proxyImageUrl = `/get-image?url=${encodeURIComponent(metadata.imageUrl)}`;
				
				preview.innerHTML = `
					<img src="${proxyImageUrl}" alt="${metadata.title}" class="album-preview-image" onerror="this.style.display='none'">
					<div class="album-preview-title">${metadata.title}</div>
					<div class="album-preview-description">${metadata.description}</div>
				`;
				preview.style.display = 'block';
			}
			
			function hideAlbumPreview() {
				document.getElementById('album-preview').style.display = 'none';
			}
			
			function populateCrewSelector() {
				const selector = document.getElementById('crew-selector');
				selector.innerHTML = '';
				
				crewData.forEach(person => {
					const option = document.createElement('div');
					option.className = 'crew-option';
					option.innerHTML = `
						<input type="checkbox" value="${person.name}" id="crew-${person.name.replace(/\s+/g, '-')}">
						<img src="${person.face}" alt="${person.name}" class="crew-face" onerror="this.style.display='none'">
						<span class="crew-option-name">${person.name}</span>
					`;
					
					option.addEventListener('click', () => {
						const checkbox = option.querySelector('input');
						checkbox.checked = !checkbox.checked;
						
						if (checkbox.checked) {
							selectedCrew.add(person.name);
							option.classList.add('selected');
						} else {
							selectedCrew.delete(person.name);
							option.classList.remove('selected');
						}
						
						updateSubmitButton();
					});
					
					selector.appendChild(option);
				});
			}
			
			// New person form functionality
			function initNewPersonForm() {
				const showBtn = document.getElementById('show-new-person-btn');
				const cancelBtn = document.getElementById('cancel-person-btn');
				const addBtn = document.getElementById('add-person-btn');
				const form = document.getElementById('new-person-form');
				const nameInput = document.getElementById('new-person-name');
				const skillsInput = document.getElementById('skills-input');
				const imageUploadArea = document.getElementById('image-upload-area');
				const imageUploadInput = document.getElementById('image-upload-input');
				
				// Show/hide form
				showBtn.addEventListener('click', () => {
					showBtn.style.display = 'none';
					form.style.display = 'block';
					// Add required attribute when form is visible
					nameInput.setAttribute('required', '');
				});
				
				cancelBtn.addEventListener('click', () => {
					resetNewPersonForm();
					form.style.display = 'none';
					showBtn.style.display = 'block';
					// Remove required attribute when form is hidden
					nameInput.removeAttribute('required');
				});
				
				// Skills autocomplete
				initSkillsAutocomplete();
				
				// Image upload
				initImageUpload();
				
				// Add person
				addBtn.addEventListener('click', () => {
					const name = nameInput.value.trim();
					
					if (!name) {
						alert('Please enter a name');
						return;
					}
					
					// Check if person already exists
					if (crewData.some(p => p.name.toLowerCase() === name.toLowerCase()) || 
						newPeople.some(p => p.name.toLowerCase() === name.toLowerCase())) {
						alert('This person already exists');
						return;
					}
					
					const newPerson = {
						name: name,
						skills: [...selectedSkills],
						image: addAlbumCurrentPersonImage
					};
					
					newPeople.push(newPerson);
					selectedCrew.add(name);
					
					updateNewPeopleList();
					updateSubmitButton();
					
					// Reset and hide form
					resetNewPersonForm();
					form.style.display = 'none';
					showBtn.style.display = 'block';
					// Remove required attribute when form is hidden
					nameInput.removeAttribute('required');
				});
			}
			
			function initSkillsAutocomplete() {
				const skillsBadgesContainer = document.getElementById('skills-badges-container');
				
				function renderSkillsBadges() {
					skillsBadgesContainer.innerHTML = allSkills.map(skill => `
						<div class="skill-badge-toggleable ${selectedSkills.includes(skill) ? 'selected' : ''}" 
							 data-skill="${skill}">${skill}</div>
					`).join('');
				}
				
				// Handle badge clicks
				skillsBadgesContainer.addEventListener('click', (e) => {
					if (e.target.classList.contains('skill-badge-toggleable')) {
						const skill = e.target.dataset.skill;
						
						if (selectedSkills.includes(skill)) {
							// Remove skill
							const index = selectedSkills.indexOf(skill);
							selectedSkills.splice(index, 1);
						} else {
							// Add skill
							selectedSkills.push(skill);
						}
						
						renderSkillsBadges();
					}
				});
				
				function addSkill(skill) {
					if (selectedSkills.includes(skill)) return;
					
					selectedSkills.push(skill);
					renderSkillsBadges();
				}
				
				// Store render function for external use
				window.renderSkillsBadges = renderSkillsBadges;
				
				// Initial render once skills are loaded
				if (allSkills.length > 0) {
					renderSkillsBadges();
				}
			}
			
			function initImageUpload() {
				const uploadArea = document.getElementById('image-upload-area');
				const uploadInput = document.getElementById('image-upload-input');
				const uploadContent = document.getElementById('upload-content');
				
				// Click to upload
				uploadArea.addEventListener('click', () => {
					uploadInput.click();
				});
				
				// Drag and drop
				uploadArea.addEventListener('dragover', (e) => {
					e.preventDefault();
					uploadArea.classList.add('dragover');
				});
				
				uploadArea.addEventListener('dragleave', () => {
					uploadArea.classList.remove('dragover');
				});
				
				uploadArea.addEventListener('drop', (e) => {
					e.preventDefault();
					uploadArea.classList.remove('dragover');
					
					const files = e.dataTransfer.files;
					if (files.length > 0) {
						handleImageUpload(files[0]);
					}
				});
				
				uploadInput.addEventListener('change', (e) => {
					if (e.target.files.length > 0) {
						handleImageUpload(e.target.files[0]);
					}
				});
				
				function handleImageUpload(file) {
					if (!file.type.startsWith('image/')) {
						alert('Please select an image file');
						return;
					}
					
					if (file.size > 5 * 1024 * 1024) {
						alert('Image size must be less than 5MB');
						return;
					}
					
					// Open cropping modal instead of directly setting the image
					window.cropModal.openCropModal(file, 'add');
				}
			}
			
			function resetNewPersonForm() {
				document.getElementById('new-person-name').value = '';
				selectedSkills = [];
				addAlbumCurrentPersonImage = null;
				
				// Reset skills badges
				const skillsBadgesContainer = document.getElementById('skills-badges-container');
				if (skillsBadgesContainer && allSkills.length > 0) {
					skillsBadgesContainer.innerHTML = allSkills.map(skill => `
						<div class="skill-badge-toggleable ${selectedSkills.includes(skill) ? 'selected' : ''}" data-skill="${skill}">${skill}</div>
					`).join('');
				}
				

				document.getElementById('upload-content').innerHTML = `
					<div class="upload-text">
						📷 Click or drag to upload profile image<br>
						<small>(JPG, PNG, max 5MB)</small>
					</div>
				`;
			}
			
			function updateNewPeopleList() {
				const list = document.getElementById('new-people-list');
				list.innerHTML = '';
				
				newPeople.forEach((person, index) => {
					const item = document.createElement('div');
					item.style.cssText = `
						display: flex;
						align-items: center;
						gap: 1rem;
						padding: 1rem;
						background: #333;
						border-radius: 12px;
						margin-bottom: 0.5rem;
						border: 2px solid #444;
					`;
					
					const imagePreview = person.image ? 
						`<img src="${URL.createObjectURL(person.image)}" style="
							width: 40px;
							height: 40px;
							border-radius: 50%;
							object-fit: cover;
							border: 2px solid #ffae52;
						" alt="${person.name}">` : 
						`<div style="
							width: 40px;
							height: 40px;
							border-radius: 50%;
							background: #555;
							display: flex;
							align-items: center;
							justify-content: center;
							color: #ccc;
							font-size: 1.2rem;
						">👤</div>`;
					
					const skillsDisplay = person.skills && person.skills.length > 0 ? 
						person.skills.map(skill => 
							`<span style="
								background: #ffae52;
								color: #1a1a1a;
								padding: 0.2rem 0.5rem;
								border-radius: 12px;
								font-size: 0.8rem;
								font-weight: 600;
							">${skill}</span>`
						).join(' ') : 
						'<span style="color: #888; font-size: 0.9rem;">No skills</span>';
					
					item.innerHTML = `
						${imagePreview}
						<div style="flex: 1;">
							<div style="color: #ffae52; font-weight: 600; margin-bottom: 0.3rem;">${person.name}</div>
							<div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">${skillsDisplay}</div>
						</div>
						<button type="button" style="
							background: #cf6679;
							color: white;
							border: none;
							padding: 0.4rem 0.8rem;
							border-radius: 6px;
							cursor: pointer;
							font-size: 0.9rem;
							font-weight: 600;
						" onclick="removeNewPerson(${index})">Remove</button>
					`;
					
					list.appendChild(item);
				});
			}
			
			// Make removeNewPerson available globally
			window.removeNewPerson = function(index) {
				const person = newPeople[index];
				selectedCrew.delete(person.name);
				newPeople.splice(index, 1);
				updateNewPeopleList();
				updateSubmitButton();
			};
			
			function updateSubmitButton() {
				const url = urlInput.value.trim();
				const hasValidUrl = url && !urlInput.classList.contains('error') && 
								   document.getElementById('url-success').style.display === 'block';
				const hasSelectedCrew = selectedCrew.size > 0;
				
				submitBtn.disabled = !(hasValidUrl && hasSelectedCrew);
			}
			
			// Form submission
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const url = urlInput.value.trim();
				const crew = Array.from(selectedCrew);
				
				submitBtn.disabled = true;
				submitBtn.textContent = 'Submitting...';
				
				try {
					// Upload images for new people first
					const processedNewPeople = [];
					
					for (const person of newPeople) {
						let processedPerson = {
							name: person.name,
							skills: person.skills || [],
							location: [],
							achievements: []
						};
						
						// Upload image if provided
						if (person.image) {
							try {
								const formData = new FormData();
								formData.append('file', person.image);
								formData.append('person_name', person.name);
								
								const uploadResponse = await fetch('/api/upload-face', {
									method: 'POST',
									body: formData
								});
								
								if (uploadResponse.ok) {
									const uploadData = await uploadResponse.json();
									processedPerson.temp_image_path = uploadData.temp_path;
								}
							} catch (uploadError) {
								console.warn('Failed to upload image for', person.name, uploadError);
							}
						}
						
						processedNewPeople.push(processedPerson);
					}
					
					const response = await fetch('/api/albums/submit', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							url,
							crew,
							new_people: processedNewPeople
						})
					});
					
					const data = await response.json();
					
					if (response.ok) {
						showSubmissionSuccess(data);
					} else {
						// Handle authentication errors specifically
						if (response.status === 401) {
							showSubmissionError('Your session has expired. Please refresh the page and log in again.');
						} else {
							showSubmissionError(data.detail || 'Submission failed');
						}
					}
				} catch (error) {
					showSubmissionError('Network error occurred');
				}
			});
			
			async function showSubmissionSuccess(data) {
				const status = document.getElementById('submission-status');
				status.innerHTML = `
					<div class="refresh-success" style="color: #03dac6; font-weight: 600; margin-bottom: 1rem;">
						✅ ${data.message}
					</div>
					<div style="color: #ccc; font-size: 0.9rem;">
						Album has been added and is now live!
					</div>
				`;
				
				// Close modal immediately
				closeModal();
				
				// Store the submitted album URL for later scrolling
				const submittedAlbumUrl = urlInput.value.trim();
				
				// Trigger refresh with retry logic to ensure new album appears
				await refreshWithRetry(submittedAlbumUrl);
			}
			
			async function refreshWithRetry(expectedAlbumUrl, maxRetries = 5, delayBetweenRetries = 200) {
				for (let attempt = 1; attempt <= maxRetries; attempt++) {
					try {
						// Check if album exists in the API before refreshing UI
						const response = await fetch("/api/albums/enriched");
						if (response.ok) {
							const enrichedAlbums = await response.json();
							const albumExists = enrichedAlbums.some(album => 
								(album.metadata && album.metadata.url === expectedAlbumUrl) || 
								album.url === expectedAlbumUrl
							);
							
							if (albumExists) {
								// Album is available, now refresh the UI with animations
								if (window.autoRefreshAlbums) {
									await window.autoRefreshAlbums(false, true); // showLoadingState=false, detectChanges=true
								} else {
									window.location.reload();
								}
								return; // Success - exit retry loop
							}
						}
						
						// Album not ready yet, wait before next attempt
						if (attempt < maxRetries) {
							await new Promise(resolve => setTimeout(resolve, delayBetweenRetries));
							delayBetweenRetries *= 1.5; // Exponential backoff
						}
					} catch (error) {
						console.warn(`Refresh attempt ${attempt} failed:`, error);
						if (attempt === maxRetries) {
							// Final fallback after all retries failed
							window.location.reload();
						}
					}
				}
				
				// If we get here, album wasn't found after all retries - do a final refresh
				if (window.autoRefreshAlbums) {
					await window.autoRefreshAlbums(false, true);
				} else {
					window.location.reload();
				}
			}
			
			function showSubmissionError(message) {
				const status = document.getElementById('submission-status');
				status.innerHTML = `
					<div style="color: #cf6679; font-weight: 600;">
						❌ ${message}
					</div>
				`;
				submitBtn.disabled = false;
				submitBtn.textContent = 'Add Album';
			}
			
			function resetForm() {
				form.reset();
				selectedCrew.clear();
				newPeople = [];
				selectedSkills = [];
				addAlbumCurrentPersonImage = null;
				hideUrlFeedback();
				hideAlbumPreview();
				updateNewPeopleList();
				updateSubmitButton();
				document.getElementById('submission-status').innerHTML = '';
				submitBtn.textContent = 'Add Album';
				
				// Reset crew selector
				document.querySelectorAll('.crew-option').forEach(option => {
					option.classList.remove('selected');
					option.querySelector('input').checked = false;
				});
				
				// Reset new person form
				const newPersonForm = document.getElementById('new-person-form');
				const showBtn = document.getElementById('show-new-person-btn');
				const nameInput = document.getElementById('new-person-name');
				if (newPersonForm.style.display === 'block') {
					resetNewPersonForm();
					newPersonForm.style.display = 'none';
					showBtn.style.display = 'block';
					// Remove required attribute when form is hidden
					nameInput.removeAttribute('required');
				}
			}
		}

		// Edit Album Modal Functionality
		function initEditAlbumModal() {
			const editAlbumFab = document.getElementById('edit-album-fab');
			const editModeOverlay = document.getElementById('edit-mode-overlay');
			const editModeMessage = document.getElementById('edit-mode-message');
			const editModalOverlay = document.getElementById('edit-album-modal-overlay');
			const editModal = document.getElementById('edit-album-modal');
			const editCloseBtn = document.getElementById('edit-album-modal-close');
			const editForm = document.getElementById('edit-album-form');
			const editSubmitBtn = document.getElementById('edit-submit-btn');
			const deleteAlbumBtn = document.getElementById('delete-album-btn');
			
			let isEditMode = false;
			let currentEditAlbum = null;
			let crewData = [];
			let selectedCrew = new Set();
			let editNewPeople = [];
			
			// Fetch crew data
			fetch('/api/crew')
				.then(r => r.json())
				.then(crew => {
					crewData = crew;
				})
				.catch(e => console.warn('Could not load crew:', e));
			
			// Delete album functionality
			deleteAlbumBtn.addEventListener('click', async () => {
				if (!currentEditAlbum) return;
				
				const albumTitle = currentEditAlbum.meta.title || 'this album';
				const confirmed = confirm(`Are you sure you want to delete "${albumTitle}"?\n\nThis action cannot be undone and will:\n- Remove the album from the collection\n- Update all crew members' climb counts\n- Remove all references to this album\n\nProceed with deletion?`);
				
				if (!confirmed) return;
				
				deleteAlbumBtn.disabled = true;
				deleteAlbumBtn.textContent = '🗑️ Deleting...';
				
				try {
					const response = await fetch(`/api/albums/delete?album_url=${encodeURIComponent(currentEditAlbum.url)}`, {
						method: 'DELETE'
					});
					
					const data = await response.json();
					
					if (response.ok) {
						showEditSubmissionSuccess({
							message: data.message,
							isDeleted: true
						});
					} else {
						showEditSubmissionError(data.detail || 'Delete failed');
					}
				} catch (error) {
					showEditSubmissionError('Network error occurred during deletion');
				} finally {
					deleteAlbumBtn.disabled = false;
					deleteAlbumBtn.textContent = '🗑️ Delete Album';
				}
			});
			
			// Initialize new person form functionality
			initEditNewPersonFormModal();
			
			// Initialize image upload for edit modal
			initEditImageUploadModal();
			
			// Toggle edit mode
			editAlbumFab.addEventListener('click', () => {
				isEditMode = !isEditMode;
				toggleEditMode();
			});
			
			function toggleEditMode() {
				if (isEditMode) {
					// Enter edit mode
					editAlbumFab.classList.add('active');
					editModeOverlay.classList.add('active');
					editModeMessage.classList.add('active');
					
					// Make album cards clickable
					document.querySelectorAll('.album-card').forEach(card => {
						card.classList.add('edit-mode');
						card.addEventListener('click', handleAlbumClick);
					});
				} else {
					// Exit edit mode
					editAlbumFab.classList.remove('active');
					editModeOverlay.classList.remove('active');
					editModeMessage.classList.remove('active');
					
					// Remove edit mode from album cards
					document.querySelectorAll('.album-card').forEach(card => {
						card.classList.remove('edit-mode');
						card.removeEventListener('click', handleAlbumClick);
					});
				}
			}
			
			function handleAlbumClick(e) {
				if (!isEditMode) return;
				
				e.preventDefault();
				e.stopPropagation();
				
				const albumCard = e.currentTarget;
				const albumUrl = albumCard.dataset.albumUrl;
				const albumMeta = albumCard.albumMeta; // This should be attached when creating cards
				
				if (albumUrl && albumMeta) {
					openEditModal(albumUrl, albumMeta);
				}
			}
			
			function openEditModal(albumUrl, albumMeta) {
				currentEditAlbum = {
					url: albumUrl,
					meta: albumMeta
				};
				
				// Exit edit mode
				isEditMode = false;
				toggleEditMode();
				
				// Populate modal with album info
				populateEditModal(albumMeta);
				
				// Show modal
				editModalOverlay.classList.add('active');
				setTimeout(() => editModal.classList.add('active'), 50);
			}
			
			function populateEditModal(albumMeta) {
				// Populate album info
				const albumInfo = document.getElementById('edit-album-info');
				const proxyImageUrl = `/get-image?url=${encodeURIComponent(albumMeta.imageUrl)}`;
				
				albumInfo.innerHTML = `
					<img src="${proxyImageUrl}" alt="${albumMeta.title}" class="album-info-image" onerror="this.style.display='none'">
					<div class="album-info-title">${albumMeta.title}</div>
					<div class="album-info-url">${currentEditAlbum.url}</div>
				`;
				
							// Get current crew for this album
			const currentCrew = albumMeta.crew || [];
			selectedCrew.clear();
			currentCrew.forEach(member => {
				// Ensure we only add the name string, not the full object
				const memberName = typeof member === 'string' ? member : member.name;
				selectedCrew.add(memberName);
			});
				
				// Populate crew selector
				populateEditCrewSelector();
			}
			
			function populateEditCrewSelector() {
				const selector = document.getElementById('edit-crew-selector');
				selector.innerHTML = '';
				
				crewData.forEach(person => {
					const isSelected = selectedCrew.has(person.name);
					const option = document.createElement('div');
					option.className = `crew-option ${isSelected ? 'selected' : ''}`;
					option.innerHTML = `
						<input type="checkbox" value="${person.name}" id="edit-crew-${person.name.replace(/\s+/g, '-')}" ${isSelected ? 'checked' : ''}>
						<img src="${person.face}" alt="${person.name}" class="crew-face" onerror="this.style.display='none'">
						<span class="crew-option-name">${person.name}</span>
					`;
					
					option.addEventListener('click', () => {
						const checkbox = option.querySelector('input');
						checkbox.checked = !checkbox.checked;
						
						if (checkbox.checked) {
							// Ensure we only add the name string, never the full object
							const memberName = typeof person === 'string' ? person : person.name;
							selectedCrew.add(memberName);
							option.classList.add('selected');
						} else {
							// Ensure we delete the name string, never the full object
							const memberName = typeof person === 'string' ? person : person.name;
							selectedCrew.delete(memberName);
							option.classList.remove('selected');
						}
					});
					
					selector.appendChild(option);
				});
			}
			
			// Close modal
			const closeEditModal = () => {
				editModal.classList.remove('active');
				setTimeout(() => {
					editModalOverlay.classList.remove('active');
					resetEditForm();
				}, 300);
			};
			
			editCloseBtn.addEventListener('click', closeEditModal);
			editModalOverlay.addEventListener('click', (e) => {
				if (e.target === editModalOverlay) closeEditModal();
			});
			
			// Form submission
			editForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const newCrew = Array.from(selectedCrew);
				
				// Validate crew selection
				if (newCrew.length === 0) {
					showEditSubmissionError('Please select at least one crew member');
					return;
				}
				
				// Validate crew limit
				if (newCrew.length > 10) {
					showEditSubmissionError('Maximum 10 crew members allowed');
					return;
				}
				
				editSubmitBtn.disabled = true;
				editSubmitBtn.textContent = 'Updating...';
				
				try {
					// Upload images for new people first
					const processedNewPeople = [];
					let imageUploadErrors = [];
					
					for (const person of editNewPeople) {
						let tempImagePath = null;
						
						// Upload image if provided
						if (person.image) {
							try {
								const formData = new FormData();
								formData.append('file', person.image);
								formData.append('person_name', person.name);
								
								const uploadResponse = await fetch('/api/upload-face', {
									method: 'POST',
									body: formData
								});
								
								if (uploadResponse.ok) {
									const uploadData = await uploadResponse.json();
									tempImagePath = uploadData.temp_path;
								} else {
									const errorData = await uploadResponse.json().catch(() => ({ detail: 'Unknown error' }));
									imageUploadErrors.push(`Failed to upload image for ${person.name}: ${errorData.detail}`);
								}
							} catch (uploadError) {
								console.error('Image upload error:', uploadError);
								imageUploadErrors.push(`Failed to upload image for ${person.name}: Network error`);
							}
						}
						
						processedNewPeople.push({
							name: person.name,
							skills: person.skills || [],
							location: person.location || [],
							achievements: person.achievements || [],
							temp_image_path: tempImagePath
						});
					}
					
					// Show warnings for image upload failures but continue
					if (imageUploadErrors.length > 0) {
						console.warn('Image upload errors:', imageUploadErrors);
					}
					
														// Ensure crew is always an array of strings
					const cleanCrew = newCrew.map(member => {
						if (typeof member === 'string') {
							return member;
						} else if (member && typeof member === 'object' && member.name) {
							return member.name;
						} else {
							console.warn('Invalid crew member:', member);
							return String(member);
						}
					});
					
					const requestPayload = {
						album_url: currentEditAlbum.url,
						crew: cleanCrew,
						new_people: processedNewPeople
					};
				
				console.log('Selected crew before processing:', Array.from(selectedCrew));
				console.log('New crew after Array.from:', newCrew);
				console.log('Clean crew after processing:', cleanCrew);
				console.log('Submitting edit request:', requestPayload);
					
					const response = await fetch('/api/albums/edit-crew', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify(requestPayload)
					});
					
					const data = await response.json();
					
					if (response.ok) {
						let successMessage = data.message;
						
						// Add info about created climbers
						if (data.created_climbers && data.created_climbers.length > 0) {
							successMessage += `\n\nNew climbers created: ${data.created_climbers.join(', ')}`;
						}
						
						// Add warnings about image uploads if any failed
						if (imageUploadErrors.length > 0) {
							successMessage += `\n\nNote: Some images failed to upload:\n${imageUploadErrors.join('\n')}`;
						}
						
						showEditSubmissionSuccess({ ...data, message: successMessage });
					} else {
						// Handle different error types
						let errorMessage = data.detail || 'Update failed';
						
						// If it's a validation error (422), pass the whole response for better error display
						if (response.status === 422) {
							try {
								errorMessage = JSON.stringify(data);
							} catch (e) {
								errorMessage = `Invalid data: ${errorMessage}`;
							}
						} else if (response.status === 400) {
							errorMessage = `Validation error: ${errorMessage}`;
						} else if (response.status === 403) {
							errorMessage = `Permission denied: ${errorMessage}`;
						} else if (response.status === 404) {
							errorMessage = `Album not found: ${errorMessage}`;
						} else if (response.status >= 500) {
							errorMessage = `Server error: ${errorMessage}`;
						}
						
						showEditSubmissionError(errorMessage);
					}
				} catch (error) {
					console.error('Edit submission error:', error);
					
					let errorMessage = 'Network error occurred';
					if (error.name === 'TypeError' && error.message.includes('fetch')) {
						errorMessage = 'Unable to connect to server. Please check your internet connection.';
					} else if (error.name === 'AbortError') {
						errorMessage = 'Request timed out. Please try again.';
					}
					
					showEditSubmissionError(errorMessage);
				} finally {
					editSubmitBtn.disabled = false;
					editSubmitBtn.textContent = 'Update Crew';
				}
			});
			
			async function showEditSubmissionSuccess(data) {
				const status = document.getElementById('edit-submission-status');
				
				if (data.isDeleted) {
					// Special handling for deletion
				status.innerHTML = `
					<div class="refresh-success" style="color: #03dac6; font-weight: 600; margin-bottom: 1rem;">
						✅ ${data.message}
					</div>
					<div style="color: #ccc; font-size: 0.9rem;">
							The album has been permanently removed from the collection.
					</div>
					`;
					
					// Find and animate the album card immediately before refresh
					if (currentEditAlbum) {
						const albumCard = document.querySelector(`[data-album-url="${currentEditAlbum.url}"]`);
						if (albumCard && window.albumParticleSystem) {
							const rect = albumCard.getBoundingClientRect();
							albumCard.remove();
							window.albumParticleSystem.createLineParticles(rect, 40);
							// Update data arrays immediately
							if (window.allAlbums) {
								window.allAlbums = window.allAlbums.filter(album => album.meta.url !== currentEditAlbum.url);
							}
							if (window.previousAlbumData) {
								window.previousAlbumData = window.previousAlbumData.filter(album => album.url !== currentEditAlbum.url);
							}
							currentEditAlbum = null;
						}
					}
					
					// Create immediate delete particles from the modal
					const modal = document.getElementById('edit-album-modal');
					if (modal && window.albumParticleSystem) {
						window.albumParticleSystem.createParticles(modal, 'red deleted', 18);
					}
				} else {
					// Regular update success
					status.innerHTML = `
						<div class="refresh-success" style="color: #03dac6; font-weight: 600; margin-bottom: 1rem;">
							✅ ${data.message}
						</div>
						<div style="color: #ccc; font-size: 0.9rem;">
							Album crew has been updated and is now live!
						</div>
				`;
				
					// Create immediate update particles from the modal
					const modal = document.getElementById('edit-album-modal');
					if (modal && window.albumParticleSystem) {
						window.albumParticleSystem.createParticles(modal, 'green updated', 15);
					}
				}
				
				// Close modal immediately and refresh in background
				closeEditModal();
				
				// For deletions, do smooth removal instead of hard refresh
				if (data.isDeleted && currentEditAlbum) {
					// Smooth deletion: find and fade out the album card
					const albumCard = document.querySelector(`[data-album-url="${currentEditAlbum.url}"]`);
					
					if (albumCard) {
						// Add smooth fade-out animation
						albumCard.style.transition = 'all 0.8s ease-out';
						albumCard.style.opacity = '0';
						albumCard.style.transform = 'scale(0.8) translateY(20px)';
						
						// After fade-out, remove and let grid auto-adjust
						setTimeout(() => {
							albumCard.remove();
							
							// Update data arrays
							if (window.allAlbums) {
								window.allAlbums = window.allAlbums.filter(album => album.meta.url !== currentEditAlbum.url);
							}
							if (window.previousAlbumData) {
								window.previousAlbumData = window.previousAlbumData.filter(album => album.url !== currentEditAlbum.url);
							}
							
							// Clear current edit album
							currentEditAlbum = null;
						}, 800);
					}
				} else {
					// Store URL before clearing currentEditAlbum
					const albumUrlToRefresh = currentEditAlbum.url;
					// Smoothly update just the edited album's crew display  
					setTimeout(() => {
						refreshSingleAlbumCrew(albumUrlToRefresh);
					}, 1500);
				}
			}
			
			function showEditSubmissionError(message) {
				const status = document.getElementById('edit-submission-status');
				
				// Handle validation errors from server
				let errorHtml = `<div style="color: #cf6679; font-weight: 600;">❌ ${message}</div>`;
				
				// Parse validation errors if it's JSON
				try {
					const parsedError = JSON.parse(message);
					if (parsedError.detail && Array.isArray(parsedError.detail)) {
						errorHtml = `<div style="color: #cf6679; font-weight: 600;">❌ Validation Errors:</div>`;
						parsedError.detail.forEach(error => {
							const field = error.loc ? error.loc.join('.') : 'unknown';
							errorHtml += `<div style="color: #cf6679; font-size: 0.9rem; margin-top: 0.5rem; padding-left: 1rem;">• ${field}: ${error.msg}</div>`;
						});
					}
				} catch (e) {
					// If it's not JSON, check if it contains validation error structure
					if (message.includes('"detail":[') && message.includes('"type"')) {
						try {
							const match = message.match(/\{\"detail\":\[(.*?)\]\}/);
							if (match) {
								const fullJson = `{"detail":[${match[1]}]}`;
								const parsedError = JSON.parse(fullJson);
								if (parsedError.detail && Array.isArray(parsedError.detail)) {
									errorHtml = `<div style="color: #cf6679; font-weight: 600;">❌ Validation Errors:</div>`;
									parsedError.detail.forEach(error => {
										const field = error.loc ? error.loc.join('.') : 'unknown';
										errorHtml += `<div style="color: #cf6679; font-size: 0.9rem; margin-top: 0.5rem; padding-left: 1rem;">• ${field}: ${error.msg}</div>`;
									});
								}
							}
						} catch (e2) {
							// Fall back to original message
						}
					}
				}
				
				status.innerHTML = errorHtml;
				editSubmitBtn.disabled = false;
				editSubmitBtn.textContent = 'Update Crew';
			}
			
			function resetEditForm() {
				selectedCrew.clear();
				currentEditAlbum = null;
				editNewPeople = [];
				editAlbumCurrentPersonImage = null;
				document.getElementById('edit-submission-status').innerHTML = '';
				editSubmitBtn.textContent = 'Update Crew';
				editSubmitBtn.disabled = false;
				
				// Reset new people list
				document.getElementById('edit-new-people-list').innerHTML = '';
				
				// Reset new person form
				const editNewPersonForm = document.getElementById('edit-new-person-form');
				const editShowBtn = document.getElementById('edit-show-new-person-btn');
				if (editNewPersonForm.style.display === 'block') {
					editNewPersonForm.style.display = 'none';
					editShowBtn.style.display = 'block';
				}
				
				// Reset image upload area
				resetEditNewPersonFormModal();
			}
			
			function initEditNewPersonFormModal() {
				const showBtn = document.getElementById('edit-show-new-person-btn');
				const cancelBtn = document.getElementById('edit-cancel-person-btn');
				const addBtn = document.getElementById('edit-add-person-btn');
				const form = document.getElementById('edit-new-person-form');
				const nameInput = document.getElementById('edit-new-person-name');
				
				// Show form
				showBtn.addEventListener('click', () => {
					showBtn.style.display = 'none';
					form.style.display = 'block';
				});
				
				// Cancel form
				cancelBtn.addEventListener('click', () => {
					form.style.display = 'none';
					showBtn.style.display = 'block';
					resetEditNewPersonFormModal();
				});
				
				// Add person
				addBtn.addEventListener('click', () => {
					const name = nameInput.value.trim();
					if (!name) {
						alert('Please enter a name');
						return;
					}
					
					// Validate name length
					if (name.length < 2) {
						alert('Name must be at least 2 characters long');
						return;
					}
					
					if (name.length > 50) {
						alert('Name must be less than 50 characters');
						return;
					}
					
					// Check if person already exists
					if (crewData.some(p => p.name.toLowerCase() === name.toLowerCase()) || 
						editNewPeople.some(p => p.name.toLowerCase() === name.toLowerCase()) ||
						selectedCrew.has(name)) {
						alert('This person already exists');
						return;
					}
					
					const newPerson = {
						name: name,
						skills: editSelectedSkills || [],
						location: [], // TODO: Add location input fields to the form
						achievements: [], // TODO: Add achievements input fields to the form
						image: editAlbumCurrentPersonImage
					};
					
					editNewPeople.push(newPerson);
					// Ensure we only add the name string to selectedCrew
					selectedCrew.add(name);
					updateEditNewPeopleList();
					
					// Reset and hide form
					resetEditNewPersonFormModal();
					form.style.display = 'none';
					showBtn.style.display = 'block';
				});
			}
			
			function resetEditNewPersonFormModal() {
				document.getElementById('edit-new-person-name').value = '';
				editAlbumCurrentPersonImage = null;
				
				// Reset image upload area
				document.getElementById('edit-upload-content').innerHTML = `
					<div class="upload-text">
						📷 Click or drag to upload profile image<br>
						<small>(JPG, PNG, max 5MB)</small>
					</div>
				`;
			}
			
			function updateEditNewPeopleList() {
				const list = document.getElementById('edit-new-people-list');
				list.innerHTML = '';
				editNewPeople.forEach((person, index) => {
					const item = document.createElement('div');
					item.style.cssText = `
						display: flex;
						align-items: center;
						gap: 1rem;
						padding: 1rem;
						background: #333;
						border-radius: 12px;
						margin-bottom: 0.5rem;
						border: 2px solid #444;
					`;
					const imagePreview = person.image ? 
						`<img src="${URL.createObjectURL(person.image)}" style="
							width: 40px;
							height: 40px;
							border-radius: 50%;
							object-fit: cover;
							border: 2px solid #ffae52;
						" alt="${person.name}">` : 
						`<div style="
							width: 40px;
							height: 40px;
							border-radius: 50%;
							background: #555;
							display: flex;
							align-items: center;
							justify-content: center;
							color: #ccc;
							font-size: 1.2rem;
						">👤</div>`;
					
					item.innerHTML = `
						${imagePreview}
						<div style="flex: 1;">
							<div style="color: #ffae52; font-weight: 600;">${person.name}</div>
							<div style="color: #888; font-size: 0.9rem;">New person</div>
						</div>
						<button type="button" style="
							background: #cf6679;
							color: white;
							border: none;
							padding: 0.4rem 0.8rem;
							border-radius: 6px;
							cursor: pointer;
							font-size: 0.9rem;
							font-weight: 600;
						" onclick="removeEditNewPerson(${index})">Remove</button>
					`;
					list.appendChild(item);
				});
			}
			
			// Global function to remove new person
			window.removeEditNewPerson = function(index) {
				const person = editNewPeople[index];
				selectedCrew.delete(person.name);
				editNewPeople.splice(index, 1);
				updateEditNewPeopleList();
			};
			
			function initEditImageUploadModal() {
				const uploadArea = document.getElementById('edit-image-upload-area');
				const uploadInput = document.getElementById('edit-image-upload-input');
				
				uploadArea.addEventListener('click', () => {
					uploadInput.click();
				});
				
				uploadArea.addEventListener('dragover', (e) => {
					e.preventDefault();
					uploadArea.classList.add('dragover');
				});
				
				uploadArea.addEventListener('dragleave', () => {
					uploadArea.classList.remove('dragover');
				});
				
				uploadArea.addEventListener('drop', (e) => {
					e.preventDefault();
					uploadArea.classList.remove('dragover');
					const files = e.dataTransfer.files;
					if (files.length > 0) {
						handleEditImageUploadModal(files[0]);
					}
				});
				
				uploadInput.addEventListener('change', (e) => {
					if (e.target.files.length > 0) {
						handleEditImageUploadModal(e.target.files[0]);
					}
				});
			}
			
			function handleEditImageUploadModal(file) {
				if (!file.type.startsWith('image/')) {
					alert('Please select an image file');
					return;
				}
				if (file.size > 5 * 1024 * 1024) {
					alert('Image size must be less than 5MB');
					return;
				}
				// Open cropping modal
				window.cropModal.openCropModal(file, 'edit-album');
			}
			

		}
	</script>
	<script src="/static/js/auth.js"></script>

	<!-- Privacy Link -->
	<a href="/privacy" class="privacy-link" title="Privacy Policy">
		<span class="privacy-link-icon">🔒</span>
		<span class="privacy-link-text">Privacy</span>
	</a>

	<script>
		// Privacy link scroll detection
		function handlePrivacyLinkVisibility() {
			const privacyLink = document.querySelector('.privacy-link');
			const scrollHeight = document.documentElement.scrollHeight;
			const scrollTop = document.documentElement.scrollTop;
			const clientHeight = document.documentElement.clientHeight;
			
			// Show when scrolled to within 100px of bottom
			if (scrollTop + clientHeight >= scrollHeight - 100) {
				privacyLink.classList.add('visible');
			} else {
				privacyLink.classList.remove('visible');
			}
		}

		// Throttled scroll listener
		let ticking = false;
		function onScroll() {
			if (!ticking) {
				requestAnimationFrame(() => {
					handlePrivacyLinkVisibility();
					ticking = false;
				});
				ticking = true;
			}
		}

		window.addEventListener('scroll', onScroll);
		window.addEventListener('resize', handlePrivacyLinkVisibility);
		
		// Check initial state
		document.addEventListener('DOMContentLoaded', () => {
			setTimeout(handlePrivacyLinkVisibility, 100);
		});
	</script>
</body>

</html>
